# Orizon セルフホスト到達ロードマップ（タスクリスト）

本ファイルはセルフホスト（Orizon 自身を Orizon でビルド）達成までの実行タスクをチェックリスト形式で管理します。達成条件は以下。
- Orizon の全ソースを Orizon コンパイラでビルドできる
- 生成バイナリで `go` 実装と同等の自己ビルド（Stage2）が成功し、機能テストが緑
- CI で自己ビルドが定期的に検証される（再現性/回帰）

---

## 0. 現状サマリ（達成済み）
- [x] レキサー: 構造体系キーワード（struct/enum/trait/impl/import/export）、ライフタイム記号（`'a` 等）をサポート
- [x] パーサー: 型パースの拡充（参照/可変参照/ポインタ/配列/関数型/ジェネリクス/ライフタイム）
- [x] AST ブリッジ: 複合型の損失なし保持（pretty-print）と逆変換（round-trip）+ ユニットテスト
- [x] 全体テスト: `go test ./...` 緑（現状）

## 1. フロントエンド（Lexer/Parser）
- [ ] パーサー: 宣言パースの実装
  - [ ] struct 宣言（フィールド、可視性、ジェネリクス）
  - [ ] enum 宣言（バリアント、データ付き/無し、ジェネリクス）
  - [ ] trait 宣言（メソッドシグネチャ、関連型）
  - [ ] impl ブロック（単独/trait 実装、where 制約）
  - [ ] type alias / newtype（core AST の `TypeDeclaration` と整合）
  - [ ] import/export（モジュール名/パス、別名、ワイルドカードの最小）
- [ ] エラー回復/同期点の拡充（宣言ブロック単位の復帰、良質な診断）
- [ ] パース単体テスト（正常/エラー/回復）

## 2. AST/AST ブリッジ
- [ ] 新規宣言ノード（struct/enum/trait/impl/import/export）を core AST と合意
  - [ ] 追加するか既存表現へ写像する設計確定（最小侵襲）
- [ ] パーサー AST ↔ core AST の往復変換を実装（Span/位置情報含む）
- [ ] 追加ユニットテスト（宣言の保持・変換の完全性）

## 3. 型システム/型検査
- [ ] 基本型/関数/ジェネリクスの型検査
- [ ] 参照/ポインタ/ライフタイム整合（借用規則の最小版）
- [ ] trait 境界/impl 解決（選択/内在化の最小）
- [ ] 型推論/単一化（最小スコープ）
- [ ] 型検査テスト（成功/失敗/診断メッセージ）

## 4. HIR/MIR/LIR 変換
- [ ] HIR 変換の網羅（宣言/複合型/ジェネリクス）
- [ ] MIR 生成（SSA/基本ブロック、最小最適化: const-prop, DCE）
- [ ] 参照/ライフタイムの低レベル化方針を確立（所有/借用の表現）
- [ ] LIR 生成と x64 emitter 連携（関数/データ配置）
- [ ] 段階テスト（小さな関数から e2e まで）

## 5. コード生成/ABI
- [ ] 呼出規約/スタックフレーム/レジスタ割付（最小実装）
- [ ] 配列/スライス/文字列のレイアウト定義
- [ ] 例外/パニック処理（最小; アボート戦略でも可）
- [ ] デバッグ情報（任意/後回し可）

## 6. ランタイム/標準ライブラリ（ブートストラップ）
- [ ] メモリアロケータ（最小; システム/arena ベース）
- [ ] 基本 I/O、スレッド/async プリミティブ（self-host 範囲で最小）
- [ ] Core 型: Option, Result, Slice, String, Vec 等
- [ ] コンパイラ依存の intrinsics/extern を定義
- [ ] 単体/e2e テスト

## 7. ツール/エコシステム
- [ ] orizon-fmt の安定化（AST 対応拡充、差分整形）
- [ ] orizon-lsp: 定義へ移動/シンボル/補完（最小）
- [ ] orizon-test: ランナー/スナップショット/ゴールデン
- [ ] パッケージマネージャ: ローカル解決・ビルドの最小

## 8. セルフホスト E2E ステージ
- [ ] Stage0: Go 実装で Orizon をビルド
- [ ] Stage1: Orizon で Orizon をビルド（成功、テスト実行）
- [ ] Stage2: Stage1 バイナリで再ビルドし差分比較/同一性検証
- [ ] 再現性ビルド（タイムスタンプ/埋め込み値の制御）

## 9. 品質ゲート/CI
- [x] 単体テストパス（`go test ./...`）
- [ ] Lint/Format の CI 化（PR ブロッカー）
- [ ] e2e セルフホストジョブ（夜間/タグ時）
- [ ] 失敗時のログ/成果物保存

## 10. パフォーマンス/安定化
- [ ] 代表ベンチ（パース/型検査/コード生成）
- [ ] 大規模入力での増分解析の実測
- [ ] メモリプロファイリング/ホットスポット最適化

## 11. ドキュメント/運用
- [ ] 言語仕様の凍結対象とバージョニング方針
- [ ] 開発者ガイド/貢献ガイド/リリース手順
- [ ] ユーザー向けクイックスタート/トラブルシュート

---

## 直近の実装順（推奨）
1) パーサー宣言群の実装 + テスト
2) AST ブリッジで宣言の往復対応
3) HIR 型/宣言対応の拡張
4) 最小 self-host subset（必要言語機能/標準ライブラリ）のスコープ確定
5) Stage1 ビルドまでを e2e で通して課題洗い出し
